#!/bin/bash

# Fonctions

function PrintHelp ()
{
        echo
        echo "Usage : morning [OPTION]..."
        echo ----------------------------
        echo
        echo "  -n                 Used to write a message to print to tomorrow."
	echo "                       Can be used with a positive integer to"
	echo "                       report the message by the number of days"
	echo
        echo "      --help         Display this help and exit"
        echo
}

function MorningRoutine () 
{
        echo ----------------------------
        date
        echo ----------------------------

        echo
        echo Executing commands
        echo ------------------

        # Execute user defined commands

        echo 
        echo Reminders
        echo -------------------
        echo 

        # Print user defined daily reminders

        day=$(date +%d)
        month=$(date +%m)
        year=$(date +%Y)


        filename="Morning_${year}_${month}_${day}.txt"

        echo
        echo Message for you
        echo ---------------

        if [ -f "$filename" ]; then
                cat "$filename"
                echo
        else
                echo No messages to display
        fi
}

function CreateFile ()
{
        # Creating the name of the file
        textarray=()

        day=$(date +%d)
        month=$(date +%m)
        year=$(date +%Y)

        # Add number of days requested or the default of one
        if [ $# -eq 1 ]; then
                day=$(($day+$1))
        else
                day=$(($day+1))
        fi

        filename="Morning_${year}_${month}_${day}.txt"

        # Read text
        read -p $'Enter text (enter eol to end): \n' text
        while [ "$text" != "eol" ]
        do
                textarray+=("$text")
                read text
        done

        # If array is empty do not create file

        # Write text to array
        for i in "${textarray[@]}"
        do
                echo $i >> "$filename"
        done
}

function CleanMessages ()
{
        # Cleaning to do

        listMornings=($(ls -1 | egrep 'Morning_[0-9]{4}_[0-9]{2}_[0-9]{2}.txt'))

        echo

        if [ ${#listMornings[@]} -gt 1 ]; then
                echo More than one file
        else
                echo one file or less
        fi
}

# Arguments parsing

if [ $# -eq 0 ]; then
        # Run daily commands
        MorningRoutine
        # Clean message folder of older messages
        CleanMessages
else
        if [ $# -gt 2 ]; then
                echo
                echo "Too many arguments : $#"
                PrintHelp
                exit 128
        fi

        if [ "$1" = "--help" ]; then
                PrintHelp
        fi

        # Writing message if parameter -n

        if [ "$1" = "-n" ]; then

                if [ $# -eq 1 ]; then
                        CreateFile
                fi

                # If there is a number of days skip ahead by that much
                if [ $# -eq 2 ]; then

                        # Test to see if number is a positive integer
                        if [[ $2 =~ ^[+]?[0-9]+$ ]]; then
                                CreateFile $2
                        else
                                echo Invalid parameter for -n option
                                PrintHelp
                        fi
                fi
        fi
fi
